<html>
<head>

<style>
body { background: #111; color: #FC0; }
a { color: #FF0; }
a:visited { color: #A60; }

</style>

  <script type="text/JavaScript">
  var pageTitle = "";

  // Set up a watcher process to reload the page on backnavigation.
  var hash = -1; // Weird initial value to guarantee initial page load.
  setInterval(function(){
      if (window.location.hash != hash) {
          hash = window.location.hash;
          loadPage();
      }
  }, 100);

  function getPage() {
      var text = this.responseText;
      text = unhtml(text);
      text = linkify(text);

      document.getElementById("payload").innerHTML = text;

      document.title = pageTitle;
  }

  function notFound() {
      document.getElementById("payload").innerHTML = "*** Not found ***";
      document.title = "404";
  }

  function beginLoad(theUrl) {
      var request = new XMLHttpRequest();
      request.onload = getPage;
      request.onerror = notFound;
      request.open("GET", theUrl, true);
      request.send();
  }

  // http://stackoverflow.com/questions/5251520/how-do-i-escape-some-html-in-javascript
  function unhtml(text) {
      return text.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
  }

  function wikiWordsToLinks(text) {
      return text.replace(
          /(\b[A-Z][a-z]+([A-Z][a-z]+|[0-9]+)+)\b/g,
          '<a href="#$1">$1</a>');
  }

  function linkifyLine(text) {
      // Image link as the only thing on the line.
      if (text.match(/^\s*([-A-Z0-9_.]+\.(png|jpg|jpeg|gif|bmp))\s*$/i)) {
          return '<img src="'+text+'" />';
      }

      var replacedText, hyperlink, wikiword;

      // http://stackoverflow.com/questions/37684/how-to-replace-plain-urls-with-links
      hyperlink = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;

      // We must never apply wikiWordsToLinks to a hyperlink part of
      // the input. So if the line has a hyperlink on it, split it
      // into the hyperlinkless head, the hyperlink part and the tail.
      // Process wikiwords in the head, process the hyperlink, then
      // recurse to the tail.

      var match = hyperlink.exec(text);
      if (match) {
          var head = text.substring(0, match.index);
          var tail = text.substring(match.index + match[0].length);
          return wikiWordsToLinks(head) + '<a href="'+match[0]+'">'+match[0]+'</a>' + linkifyLine(tail);
      } else {
          return wikiWordsToLinks(text);
      }
  }

  function linkify(text) {
      var lines = text.split('\n');
      var result = [];

      for (var i = 0; i < lines.length; i++) {
          result.push(linkifyLine(lines[i]));
      }

      return result.join("\n");
  }

  function loadPage() {
      if (window.location.hash) {
          pageTitle = window.location.hash.substr(1);
      } else {
          pageTitle = 'ReadMe';
      }
      beginLoad(pageTitle);
  }
  </script>

</head>
<body>
  <pre id="payload">The wikilike browser view requires JavaScript to run.</pre>
</body>
</html>
